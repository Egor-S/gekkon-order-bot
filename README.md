## Системные требования:
- `git`
- `Python 3`
- `virtualenv`

> Установить недостающие компоненты можно с помощью системного пакетного менеджера (`apt-get`, `yum`, `pacman` и т.д.)

## Загрузка проекта

```bash
git clone https://github.com/Egor-S/gekkon-order-bot.git
cd gekkon-order-bot
```

## Подготовка аккаунтов
Большая часть настроек располагается в файле `config.json`, который необходимо расположить в скаченную папку.

### `google_service.json`
Зайдите на сайт [Google API Console](https://console.developers.google.com/projectselector/apis/dashboard?pli=1) и выберите `Создать проект`.

После создания перейдите в раздел `Учетные данные` и нажмите на `Создать учетные данные` --> `Ключ сервисного аккаунта`. Создайте новый сервисный аккаунт с ключом типа `JSON`.

В завершение процедуры создания учетных данных будет скачан файл, который необходимо переименовать в `google_service.json` и поместить в скаченную ранее папку.

### Токен для телеграм бота
Написать `@BotFather`, следовать указаниям. В ответ будет получено сообщение с токеном - поместите его в поле `telegram-token` в файле `config.json`.

### Google таблицы
Разрешите чтение/запись для e-mail из файла `google_service.json` в нужных таблицах (Google может прислать письмо, что такого ящика не существует - не обращайте внимание).

Структура каталога: на листе `Номенклатура` три колонки начиная **со второй строки**

Заголовок категории:
1. Название новой категории \[Столбец A\]

Позиция в каталоге:
1. Пустота \[Столбец A\]
2. Артикул (произвольное число) \[Столбец B\]
3. Описание \[Столбец C\]

> Название позиции берется из описания, между кавычек. При отсутствии кавычек - берется описание полностью.

В таблице с заказами нужно создать лист `Orders`, а **в первой строке** разместить заголовки (id, артикул, название, количество, имя сотрудника, дата). В первой колонке, начиная со второй строки, указываются id заказов.

В файле `config.json` запишите:
- id таблицы с листом `Номенклатура` в поле `table` в поле `catalog`
- id таблицы с листом `orders` в поле `table` в поле `orders`

> Оба листа можно разместить в одной таблице, тогда в оба поля нужно записать один и тот же id

### Настройка прокси
Для использования socks5 прокси необходимо в файле `config.json`:

1. Создать объект в поле `proxy`
2. Записать в поле `url` в поле `proxy` адрес и порт прокси-сервера в формате `socks5://ip_adress:port`
3. Записать в поля `user` и `password` в поле `proxy` имя пользователя и пароль соответственно (при отсутствии указать пустую строку `""`)

### Приветственное сообщение
Сообщение, которое печатается по команде `/start`, можно настроить в файле `config.json` в поле `welcome-message`.

### Пример `config.json`
```json
{
    "telegram-token": "<telegram token>",
    "catalog": {
        "table": "<catalog table id>",
        "sheet": "Номенклатура",
        "range": "A2:C"
    },
    "orders": {
        "table": "<orders table id>",
        "sheet": "Orders",
        "range": "A:F",
        "id-range": "A2:A"
    },
    "notification-chat": <notification chat id>,
    "proxy": {
        "url": "<socks5 proxy url>",
        "user": "<username>",
        "password": "<password>"
    },
    "welcome-message": "Для начала оформления заявки отправьте /order\nДля отмены отправьте /abort"
}
```

### Подготовка окружения
Создаем виртуальное окружение:

```bash
virtualenv venv -p python3
```

Устанавливаем зависимости:

```bash
venv/bin/pip install -r requirements.txt
```

Запускаем бота:

```bash
venv/bin/python run.py
```

Если все действия выполнены правильно, то будет выведено сообщение формата "Logged in as @YourBotName".

Для остановки бота нажмите `Ctrl+C`.



### Канал для оповещений
Добавьте бота в нужный канал и вызовите команду `/chatid` (он должен быть запущен). Полученное значение (для групп со знаком минус) запишите в поле `notification-chat` в файле `config.json`.
Для вступления изменений в силу - перезапустите бота.

### Завершение настройки
Настройте удобным для вас способом (`cron`, `rc.local` и т.д.) запуск бота при старте системы.

**Важно!** Запускать бота необходимо из директории проекта:

```bash
cd /path/to/gekkon-order-bot
venv/bin/python run.py &
```

### Обновление каталога предметов
Обновление каталога происходит автоматически, если данные старше 30 минут. Чтобы немедленно обновить каталог используйте команду `/forceupdate`.